<template>
  <div class="mobile_hidden chat-siderbar-content relative shadow-xl" style="
    order: 4;
">

    <div style="box-shadow: 0 0 #0000, 0 0 #0000, 0 1px 2px 0 rgb(0 0 0 / 0.05);"
      class="chats-content overflow-hidden flex flex-col justify-between bg-white p-6 border border-[#e5e7eb] w-[440px] vh-100">

      <!-- Heading -->
      <div class="flex flex-col space-y-1.5 pb-6 z-10">

        <div class="font-semibold text-lg tracking-tight flex items-center">

          <a-trigger trigger="click" show-arrow>
            <svg data-v-d9eddb53="" class="mr-3 cursor-pointer" width="20" height="20" viewBox="0 0 20 20" fill="none"
              xmlns="http://www.w3.org/2000/svg">
              <path data-v-d9eddb53="" fill-rule="evenodd" clip-rule="evenodd"
                d="M2.5 5L5 5L5 2.5L2.5 2.5L2.5 5ZM5 11.25L2.5 11.25L2.5 8.75L5 8.75L5 11.25ZM17.5 11.25L15 11.25L15 8.75L17.5 8.75L17.5 11.25ZM8.75 11.25L11.25 11.25L11.25 8.75L8.75 8.75L8.75 11.25ZM5 17.5L2.5 17.5L2.5 15L5 15L5 17.5ZM15 17.5L17.5 17.5L17.5 15L15 15L15 17.5ZM11.25 17.5L8.75 17.5L8.75 15L11.25 15L11.25 17.5ZM17.5 5L15 5L15 2.5L17.5 2.5L17.5 5ZM8.75 5L11.25 5L11.25 2.5L8.75 2.5L8.75 5Z"
                fill="currentColor"></path>
            </svg>
            <template #content>
              <div class="bg-white rounded-xl shadow-xl p-4">
                <a-button type="primary" class="w-full mb-2" @click="add_new_chat()">
                  <template #icon>
                    <icon-plus />
                  </template>
                  新增对话
                </a-button>

                <a-spin :loading="left_loding" v-if="messages.length > 0">
                  <ul class="space-y-2">
                    <li v-for="(item, index) in messages" :key="index">
                      <div @click="check_message(item[item.length - 1].session_id)"
                        class="flex items-center cursor-pointer p-2 text-base font-normal text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700">
                        <svg t="1717139947315" class="icon mr-2" viewBox="0 0 1024 1024" version="1.1"
                          xmlns="http://www.w3.org/2000/svg" p-id="6338" width="24" height="24">
                          <path
                            d="M1023.910943 511.999898c5.11911 317.794367-194.116663 516.825376-511.91103 511.911029-317.794367 4.914346-516.825376-194.116663-511.91103-511.911029C-4.825463 194.20553 194.205546-4.825478 511.999913 0.088868c317.794367-4.914346 516.825376 194.116663 511.91103 511.91103z"
                            fill="#3377FF" p-id="6339"></path>
                          <path
                            d="M1022.477592 566.671996C1006.915497 340.40732 852.318366 201.16752 614.382119 204.85328c-254.112635-4.095288-413.624112 155.416189-409.528824 409.528824-3.890524 237.936247 135.554041 392.533378 361.613952 408.095473 268.036615-16.381153 439.629192-187.97373 456.010345-455.805581z"
                            fill="#336DFF" p-id="6340"></path>
                          <path
                            d="M1015.515602 629.944199C985.824762 491.523456 876.480566 407.160519 716.764325 409.617692c-190.635668-3.071466-310.218084 116.51095-307.146618 307.146618-2.457173 159.716241 81.905765 269.060437 220.121743 298.751277 211.112109-34.400421 351.375731-174.664043 385.776152-385.571388z"
                            fill="#3364FF" p-id="6341"></path>
                          <path
                            d="M997.701098 705.707031C964.734028 646.734881 902.076118 613.153517 819.146531 614.382104c-127.1587-2.047644-206.812056 77.605712-204.764412 204.764412-1.433351 82.929587 32.352777 145.587497 91.120163 178.554567a431.233852 431.233852 0 0 0 292.198816-291.994052z"
                            fill="#335AFF" p-id="6342"></path>
                          <path
                            d="M163.900413 225.329721m266.193735 0l163.81153 0q266.193736 0 266.193735 266.193735l0 0q0 266.193736-266.193735 266.193736l-163.81153 0q-266.193736 0-266.193735-266.193736l0 0q0-266.193736 266.193735-266.193735Z"
                            fill="#80AAFF" p-id="6343"></path>
                          <path
                            d="M409.617707 819.146516v-102.382206h163.81153l-147.430377 110.572782a10.238221 10.238221 0 0 1-16.381153-8.190576z"
                            fill="#80AAFF" p-id="6344"></path>
                          <path
                            d="M511.999913 496.642567m-40.952882 0a40.952882 40.952882 0 1 0 81.905764 0 40.952882 40.952882 0 1 0-81.905764 0Z"
                            fill="#FFFFFF" p-id="6345"></path>
                          <path
                            d="M368.664825 496.642567m-40.952883 0a40.952882 40.952882 0 1 0 81.905765 0 40.952882 40.952882 0 1 0-81.905765 0Z"
                            fill="#FFFFFF" p-id="6346"></path>
                          <path
                            d="M655.335001 496.642567m-40.952882 0a40.952882 40.952882 0 1 0 81.905765 0 40.952882 40.952882 0 1 0-81.905765 0Z"
                            fill="#FFFFFF" p-id="6347"></path>
                        </svg>
                        <h6 class="text-truncate mb-0 me-auto" v-if="item[item.length - 1].message_b">
                          {{ item[item.length - 1].message_b }}
                        </h6>
                        <h6 class="text-truncate mb-0 me-auto" v-else>
                          {{
                            item[item.length - 1].question
                              ? item[item.length - 1].question
                              : "新会话"
                          }}
                        </h6>
                      </div>
                    </li>
                  </ul>
                  <a-pagination size="small" :total="ms_count" :current="page" :page-size="limit"
                    class="justify-content-center mt-2" background simple @change="handleCurrentChange" />
                </a-spin>

                <a-empty v-else />
              </div>
            </template>
          </a-trigger>

          AI小对话

        </div>
        <p class="text-sm text-[#6b7280] leading-3">
          与AI小对话，获取更多帮助
        </p>
      </div>




      <!-- Chat Container -->
      <div class="overflow-hidden h-[474px] w-full mb-2 flex-1 z-10 " v-if="me_message.length > 0"
        style="min-width: 100%;">
        <a-spin :loading="loadins" class="overflow-x-hidden h-full overflow-y-auto chat-message-small">
          <!-- Chat Message AI -->
          <div class="flex gap-3 my-4 text-gray-600 text-sm flex-1"><span
              class="relative flex shrink-0 overflow-hidden rounded-full w-8 h-8">
              <div class="rounded-full bg-gray-100 border p-1"><svg stroke="none" fill="black" stroke-width="1.5"
                  viewBox="0 0 24 24" aria-hidden="true" height="20" width="20" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z">
                  </path>
                </svg></div>
            </span>
            <div class="leading-relaxed flex flex-col overflow-hidden"><span
                class="block font-bold text-gray-700 mb-2">AI
              </span>
              <div class="bg-white p-4 rounded-xl shadow-sm">
                请开始您的对话吧~
              </div>
            </div>
          </div>


          <div class="px-2" v-for="(item, index) in me_message" :key="index">
            <!--  User Chat Message -->
            <div v-if="item.question" class="flex gap-3 my-4 text-gray-600 text-sm flex-1 z-10">
              <span class="relative flex shrink-0 overflow-hidden rounded-full w-8 h-8">
                <div class="rounded-full bg-gray-100 border p-1"><svg stroke="none" fill="black" stroke-width="0"
                    viewBox="0 0 16 16" height="20" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6Zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0Zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4Zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10Z">
                    </path>
                  </svg></div>
              </span>
              <div class="leading-relaxed flex flex-col overflow-hidden"><span
                  class="block font-bold text-gray-700 mb-2">User
                </span>
                <div class="bg-white p-4 rounded-xl shadow-sm" v-html="renderMarkdown(item.question)">
                </div>
              </div>
            </div>
            <!-- Ai Chat Message  -->
            <div class="flex gap-3 my-4 text-gray-600 text-sm flex-1" v-if="item.message">
              <span class="relative flex shrink-0 overflow-hidden rounded-full w-8 h-8">
                <div class="rounded-full bg-gray-100 border p-1"><svg stroke="none" fill="black" stroke-width="1.5"
                    viewBox="0 0 24 24" aria-hidden="true" height="20" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round"
                      d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z">
                    </path>
                  </svg></div>
              </span>
              <div class="leading-relaxed flex flex-col overflow-hidden"><span
                  class="block font-bold text-gray-700 mb-2">AI
                </span>
                <div class="bg-white p-4 rounded-xl shadow-sm" v-html="item.message
                    ? renderMarkdown(item.message).replace(
                      /\\n/g,
                      '\n'
                    )
                    : ''
                  ">
                </div>
              </div>
            </div>
          </div>


        </a-spin>

      </div>
      <div class="flex items-center justify-center flex-col z-10" v-else>
        <svg t="1717140155673" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
          p-id="25068" width="128" height="128">
          <path
            d="M792 222a10 10 0 0 1 10 10v406l-141.922-83.2 11.828-6.934H362a10 10 0 0 1-10-10V232a10 10 0 0 1 10-10h430z"
            fill="#DFECFD" p-id="25069"></path>
          <path
            d="M802 668c-5.246 0-10.488-1.374-15.172-4.12l-141.922-83.2a30.28 30.28 0 0 1-4.012-2.814H362c-22.056 0-40-17.944-40-40V232c0-22.056 17.944-40 40-40h430c22.056 0 40 17.944 40 40v406a30.004 30.004 0 0 1-30 30z m-100.29-123.568L772 585.638V252H382v265.868h289.906a30 30 0 0 1 29.804 26.564z"
            fill="#DFECFD" p-id="25070"></path>
          <path
            d="M222 733.936V544a10 10 0 0 1 10-10h270a10 10 0 0 1 10 10v189.934a10 10 0 0 1-10 10h-196.164l7.626 4.468L222 802v-68.064z"
            fill="#4988FD" p-id="25071"></path>
          <path
            d="M222 832a30 30 0 0 1-30-30V544c0-22.056 17.944-40 40-40h270c22.056 0 40 17.944 40 40v189.934c0 22.056-17.944 40-40 40h-172.784c-0.194 0.12-0.388 0.236-0.584 0.352l-91.462 53.598A30.008 30.008 0 0 1 222 832z m30-268v185.648l25.242-14.792a30 30 0 0 1 28.594-20.924H482V564H252z"
            fill="#4988FD" p-id="25072"></path>
          <path d="M492 692h-100c-11.046 0-20-8.956-20-20s8.954-20 20-20h100c11.046 0 20 8.956 20 20s-8.954 20-20 20z"
            fill="#DFECFD" p-id="25073"></path>
          <path d="M552 304h-160c-11.046 0-20-8.954-20-20s8.954-20 20-20h160c11.044 0 20 8.954 20 20s-8.956 20-20 20z"
            fill="#4988FD" p-id="25074"></path>
        </svg>
        <a-button type="primary" @click="add_new_chat()">
          <template #icon>
            <icon-plus />
          </template>

          新建对话
        </a-button>
        <span class="mt-2">
          请点击左上角对话列表中的对话
        </span>
      </div>
      <!-- Input box  -->
      <div class="flex items-center pt-0 z-10">
        <form class="flex items-center justify-center w-full space-x-2">

          <div class="w-full relative">
            <a-dropdown @select="handleSelect">
              <a-tag color="arcoblue" class="mb-2 cursor-pointer">
                <svg t="1717093814203" class="icon mr-1" viewBox="0 0 1228 1024" version="1.1"
                  xmlns="http://www.w3.org/2000/svg" p-id="7696" width="16" height="16">
                  <path d="M0 698.12224l601.4976-262.02112 622.01856 262.02112-611.86048 282.33728z" fill="#4A80FC"
                    p-id="7697"></path>
                  <path d="M0 469.52448L601.4976 207.6672l622.01856 261.81632-611.86048 282.29632z" fill="#4A80FC"
                    opacity=".5" p-id="7698"></path>
                  <path d="M0 261.81632L601.4976 0l622.01856 261.81632-611.86048 282.33728z" fill="#4A80FC" opacity=".1"
                    p-id="7699"></path>
                </svg>
                {{ now_model_title }}
              </a-tag>
              <template #content>

                <a-dgroup v-if="counter.setting.gpt_new_qs_open == '1'">
                  <template #title>
                    <div class="flex items-center mb-2">
                      <svg fill="currentColor" fill-rule="evenodd" height="14" viewBox="0 0 24 24" width="14"
                        xmlns="http://www.w3.org/2000/svg" style="margin-top:0.2px;flex: 0 0 auto; line-height: 1;">
                        <title>OpenAI</title>
                        <path
                          d="M21.55 10.004a5.416 5.416 0 00-.478-4.501c-1.217-2.09-3.662-3.166-6.05-2.66A5.59 5.59 0 0010.831 1C8.39.995 6.224 2.546 5.473 4.838A5.553 5.553 0 001.76 7.496a5.487 5.487 0 00.691 6.5 5.416 5.416 0 00.477 4.502c1.217 2.09 3.662 3.165 6.05 2.66A5.586 5.586 0 0013.168 23c2.443.006 4.61-1.546 5.361-3.84a5.553 5.553 0 003.715-2.66 5.488 5.488 0 00-.693-6.497v.001zm-8.381 11.558a4.199 4.199 0 01-2.675-.954c.034-.018.093-.05.132-.074l4.44-2.53a.71.71 0 00.364-.623v-6.176l1.877 1.069c.02.01.033.029.036.05v5.115c-.003 2.274-1.87 4.118-4.174 4.123zM4.192 17.78a4.059 4.059 0 01-.498-2.763c.032.02.09.055.131.078l4.44 2.53c.225.13.504.13.73 0l5.42-3.088v2.138a.068.068 0 01-.027.057L9.9 19.288c-1.999 1.136-4.552.46-5.707-1.51h-.001zM3.023 8.216A4.15 4.15 0 015.198 6.41l-.002.151v5.06a.711.711 0 00.364.624l5.42 3.087-1.876 1.07a.067.067 0 01-.063.005l-4.489-2.559c-1.995-1.14-2.679-3.658-1.53-5.63h.001zm15.417 3.54l-5.42-3.088L14.896 7.6a.067.067 0 01.063-.006l4.489 2.557c1.998 1.14 2.683 3.662 1.529 5.633a4.163 4.163 0 01-2.174 1.807V12.38a.71.71 0 00-.363-.623zm1.867-2.773a6.04 6.04 0 00-.132-.078l-4.44-2.53a.731.731 0 00-.729 0l-5.42 3.088V7.325a.068.068 0 01.027-.057L14.1 4.713c2-1.137 4.555-.46 5.707 1.513.487.833.664 1.809.499 2.757h.001zm-11.741 3.81l-1.877-1.068a.065.065 0 01-.036-.051V6.559c.001-2.277 1.873-4.122 4.181-4.12.976 0 1.92.338 2.671.954-.034.018-.092.05-.131.073l-4.44 2.53a.71.71 0 00-.365.623l-.003 6.173v.002zm1.02-2.168L12 9.25l2.414 1.375v2.75L12 14.75l-2.415-1.375v-2.75z">
                        </path>
                      </svg>
                      <h4 class="mb-0 ml-1" style="font-size: 13px">常用大模型</h4>
                    </div>

                  </template>
                  <a-doption v-for="(n_mod, n_mod_index) in model_list" :key="n_mod_index" :value="n_mod_index">
                    <div class="flex justify-content-between min-w-48 items-center">
                      <div class="flex items-center">
                        <svg t="1717144429409" class="icon mr-1" viewBox="0 0 1024 1024" version="1.1"
                          xmlns="http://www.w3.org/2000/svg" p-id="27662" width="16" height="16">
                          <path d="M512 512m-512 0a512 512 0 1 0 1024 0 512 512 0 1 0-1024 0Z" fill="#F2F3F4"
                            p-id="27663"></path>
                          <path
                            d="M766.134857 588.105143c1.243429 0.438857 1.828571 2.377143 1.828572 3.657143 0.548571 27.062857-8.118857 78.665143-45.458286 121.636571-54.674286 62.829714-99.547429 59.026286-96.804572 71.899429 1.499429 7.241143 22.491429 4.644571 41.801143-2.267429 2.121143-0.731429 5.705143-2.998857 8.192-0.146286 2.706286 3.181714 1.243429 6.582857-0.365714 7.606858-27.136 17.188571-73.984 20.882286-81.005714-1.609143-5.632-18.212571 6.144-29.44 31.670857-42.422857 17.590857-8.996571 35.474286-18.651429 46.116571-28.306286l1.024-0.877714c2.413714-1.755429 2.304-4.937143 0.438857-7.058286a5.010286 5.010286 0 0 0-5.997714-1.170286c-26.916571 17.846857-61.952 25.746286-89.088 28.891429-65.828571 7.643429-104.850286-4.900571-149.504-25.965715-4.827429-2.230857-2.925714-6.4 1.097143-6.4 22.893714 0 94.208-2.157714 194.304-33.901714 88.027429-27.977143 125.257143-67.291429 138.130286-81.993143 0.804571-1.024 2.413714-2.194286 3.620571-1.718857v0.146286z m-307.2-300.251429l6.509714 11.556572a199.021714 199.021714 0 0 1 73.654858-13.494857 221.769143 221.769143 0 0 1 170.861714 83.126857l1.353143-0.731429c8.886857-4.864 24.685714-6.436571 30.976 1.462857 11.227429 17.334857 19.529143 36.425143 24.576 56.466286 2.742857 10.459429 3.072 14.884571-11.044572 21.906286 6.619429 20.260571 8.630857 41.837714 9.435429 63.122285 2.377143 58.806857-83.236571 110.628571-203.666286 136.704-113.627429 24.429714-184.612571 19.602286-205.056-8.886857a161.828571 161.828571 0 0 1-23.149714-47.725714l-3.766857 0.731429c-8.557714 1.097143-20.516571 0.621714-23.698286-8.923429a378.477714 378.477714 0 0 1-12.873143-54.528 20.443429 20.443429 0 0 1 13.604572-23.771429c6.107429-2.304 12.434286-3.730286 18.907428-4.096 7.68-80.201143 50.322286-152.649143 115.053714-189.513142l-5.924571-10.276572a40.704 40.704 0 0 1-45.897143-32 41.069714 41.069714 0 0 1 23.186286-46.006857 40.484571 40.484571 0 0 1 49.481143 13.312 41.179429 41.179429 0 0 1-2.56 51.565714z m120.137143 40.082286c-89.782857 3.108571-163.584 78.957714-163.584 166.546286-0.804571 29.147429 6.582857 57.892571 21.430857 82.907428 12.690286 23.552 73.764571 30.72 160.219429 5.229715 89.124571-26.331429 175.542857-89.234286 157.842285-136.228572-25.819429-69.485714-86.125714-121.563429-175.872-118.491428h-0.036571z"
                            fill="#495466" p-id="27664"></path>
                          <path
                            d="M537.234286 454.473143c5.12 2.377143 9.069714 6.692571 10.861714 11.922286l10.349714 28.964571a19.858286 19.858286 0 0 1-0.950857 15.835429 20.882286 20.882286 0 0 1-12.361143 10.422857 22.198857 22.198857 0 0 1-16.457143-0.804572 20.589714 20.589714 0 0 1-10.861714-11.885714l-10.313143-29.037714a19.821714 19.821714 0 0 1 0.841143-15.835429 22.198857 22.198857 0 0 1 28.818286-9.581714h0.073143zM665.124571 426.349714l10.605715 26.477715a19.419429 19.419429 0 0 1-10.24 25.234285 18.285714 18.285714 0 0 1-14.299429-0.036571 18.761143 18.761143 0 0 1-10.057143-10.459429l-10.605714-26.624a19.346286 19.346286 0 0 1 10.24-25.051428c9.545143-3.986286 20.443429 0.694857 24.356571 10.496v-0.036572z"
                            fill="#7166EF" p-id="27665"></path>
                        </svg>
                        {{ n_mod.title }}
                      </div>



                    </div>

                  </a-doption>
                </a-dgroup>
                <hr style="margin-top: 5px;margin-bottom: 11px!important;color:#D8D8D8 !important;">
                <a-dgroup v-if="counter.setting.fly_qs_open == '1'">
                  <template #title>
                    <div class="flex items-center mb-2">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" fill-rule="evenodd" height="14"
                        viewBox="0 0 24 24" width="14" style="flex: 0 0 auto; line-height: 1;">
                        <title>Spark</title>
                        <path
                          d="M11.615 0l6.237 6.107c2.382 2.338 2.823 3.743 3.161 6.15-1.197-1.732-1.776-2.02-4.504-2.772C12.48 8.374 11.095 5.933 11.615 0z" />
                        <path
                          d="M9.32 2.122C4.771 6.367 2 9.182 2 13.08c0 5.76 4.288 9.788 9.745 9.918 5.457.13 9.441-5.284 9.095-8.403-.347-3.118-4.418-3.81-4.418-3.81 1.69 3.16-.13 8.098-4.894 8.098-5.154 0-6.8-6.02-4.2-9.008.82 1.617 1.879 2.563 2.674 3.273.717.64 1.219 1.09 1.136 1.664-.173 1.213-1.385.866-1.385.866.346.607 3.6 1.473 4.59-1.342.613-1.741-.423-2.789-1.714-4.096-1.632-1.651-3.672-3.717-3.31-8.118z" />
                      </svg>
                      <h4 class="mb-0 ml-1" style="font-size: 13px">星火大模型</h4>
                    </div>

                  </template>
                  <a-doption value="xf35">
                    <div class="flex justify-content-between min-w-48 items-center">
                      <div class="flex items-center">
                        <a-avatar :size="16" class="mr-1">
                          <img src="@/assets/images/xinghuo.png" alt="avatar" />
                        </a-avatar>
                        星火3.5
                      </div>



                    </div>

                  </a-doption>
                </a-dgroup>
                <hr style="margin-top: 5px;margin-bottom: 11px!important;color:#D8D8D8 !important;">
                <a-dgroup v-if="counter.setting.wenxin_baidu_open == '1'">
                  <template #title>
                    <div class="flex items-center mb-2">
                      <svg fill="currentColor" fill-rule="evenodd" height="14" viewBox="0 0 24 24" width="14"
                        xmlns="http://www.w3.org/2000/svg" style="margin-top:1px;flex: 0 0 auto; line-height: 1;">
                        <title>Wenxin</title>
                        <path
                          d="M11.32 1.176a1.4 1.4 0 011.36 0l8.64 4.843c.421.234.68.67.68 1.141v9.68c0 .472-.259.908-.68 1.143l-8.64 4.84a1.4 1.4 0 01-1.36 0l-8.64-4.84A1.31 1.31 0 012 16.84V7.159c0-.471.259-.907.68-1.142l8.64-4.84zm7.42 13.839V8.227L12.002 12 12 19.551l6.059-3.394a1.31 1.31 0 00.68-1.142zM12.68 4.833a1.393 1.393 0 00-1.36 0L5.944 7.846c-.421.235-.68.67-.68 1.142v6.027c0 .47.259.905.68 1.142l2.795 1.566V11.09a1.546 1.546 0 00.221.79 1.527 1.527 0 01-.216-.834l.004-.094.02-.15.018-.084.017-.062.039-.117.062-.142.035-.065.081-.13.094-.122.084-.091.08-.075.125-.1.071-.048.134-.076 5.87-3.29-2.796-1.566z">
                        </path>
                      </svg>
                      <h4 class="mb-0 ml-1" style="font-size: 13px">百度大模型</h4>
                    </div>

                  </template>
                  <a-doption value="ErnieBot">
                    <div class="flex justify-content-between min-w-48 items-center">
                      <div class="flex items-center">
                        <a-avatar :size="16" class="mr-1">
                          <img src="@/assets/images/wenxin.png" alt="avatar" />
                        </a-avatar>
                        文心3.5
                      </div>



                    </div>
                  </a-doption>
                  <a-doption value="ErnieBot4">
                    <div class="flex justify-content-between min-w-48 items-center">
                      <div class="flex items-center">
                        <a-avatar :size="16" class="mr-1">
                          <img src="@/assets/images/wenxin.png" alt="avatar" />
                        </a-avatar>
                        文心4.0
                      </div>



                    </div>
                  </a-doption>
                </a-dgroup>
                <hr style="margin-top: 5px;margin-bottom: 11px!important;color:#D8D8D8 !important;">
                <a-dgroup v-if="counter.setting.glm_open == '1'">
                  <template #title>
                    <div class="flex items-center mb-2">
                      <svg fill="currentColor" fill-rule="evenodd" height="14" viewBox="0 0 24 24" width="14"
                        xmlns="http://www.w3.org/2000/svg" style="flex: 0 0 auto; line-height: 1;">
                        <title>Qingyan</title>
                        <g>
                          <path
                            d="M6.075 10.494C7.6 9.446 9.768 8.759 12.222 8.759c2.453 0 4.622.687 6.147 1.735.77.53 1.352 1.133 1.74 1.77C20 10 20 10 20.687 9.362a9.276 9.276 0 00-1.008-.8c-1.958-1.347-4.598-2.143-7.457-2.143-2.858 0-5.499.796-7.457 2.144-1.955 1.345-3.325 3.322-3.325 5.647 0 2.326 1.37 4.303 3.322 5.646C6.721 21.205 9.362 22 12.22 22c2.859 0 5.5-.795 7.457-2.144C21.63 18.513 23 16.538 23 14.21c0-1.48-.554-2.817-1.46-3.94-.046 1.036-.41 2.03-1.012 2.937.099.325.149.663.15 1.003 0 1.33-.782 2.664-2.313 3.717-1.524 1.048-3.692 1.735-6.146 1.735-2.453 0-4.623-.687-6.147-1.735C4.544 16.874 3.76 15.54 3.76 14.21c.003-1.33.785-2.663 2.315-3.716z">
                          </path>
                          <path
                            d="M3.747 11.494c-.62 1.77-.473 3.365.332 4.51.806 1.144 2.254 1.813 4.117 1.813 1.86 0 4.029-.68 6.021-2.1 1.993-1.42 3.35-3.251 3.967-5.017.62-1.769.473-3.364-.332-4.51-.806-1.143-2.254-1.812-4.117-1.812-1.86 0-4.029.68-6.021 2.099-1.993 1.42-3.35 3.252-3.967 5.017zm-2.228-.79c.8-2.28 2.487-4.498 4.83-6.167C8.691 2.866 11.33 2 13.734 2c2.4 0 4.678.874 6.045 2.817 1.366 1.943 1.431 4.394.633 6.674-.8 2.282-2.487 4.499-4.83 6.168-2.344 1.67-4.981 2.536-7.387 2.537-2.4 0-4.678-.874-6.045-2.817-1.368-1.943-1.431-4.396-.633-6.674h.002z">
                          </path>
                        </g>
                      </svg>
                      <h4 class="mb-0 ml-1" style="font-size: 13px">智谱大模型</h4>
                    </div>

                  </template>
                  <a-doption value="chatglm_std">
                    <div class="flex justify-content-between min-w-48 items-center">
                      <div class="flex items-center">
                        <a-avatar :size="16" class="mr-1">
                          <img src="@/assets/images/zhipu.png" alt="avatar" />
                        </a-avatar>
                        GLM3
                      </div>


                    </div>
                  </a-doption>
                  <a-doption value="chatglm_pro">
                    <div class="flex justify-content-between min-w-48 items-center">
                      <div class="flex items-center">
                        <a-avatar :size="16" class="mr-1">
                          <img src="@/assets/images/zhipu.png" alt="avatar" />
                        </a-avatar>
                        GLM4
                      </div>


                    </div>
                  </a-doption>

                </a-dgroup>
                <hr style="margin-top: 5px;margin-bottom: 11px!important;color:#D8D8D8 !important;">
                <a-dgroup v-if="counter.setting.ali_model_open == '1'">
                  <template #title>
                    <div class="flex items-center mb-2">
                      <svg fill="currentColor" fill-rule="evenodd" height="14" viewBox="0 0 24 24" width="14"
                        xmlns="http://www.w3.org/2000/svg" style="flex: 0 0 auto; line-height: 1;">
                        <title>Tongyi</title>
                        <path
                          d="M12.604 1.34c.393.69.784 1.382 1.174 2.075a.18.18 0 00.157.091h5.552c.174 0 .322.11.446.327l1.454 2.57c.19.337.24.478.024.837-.26.43-.513.864-.76 1.3l-.367.658c-.106.196-.223.28-.04.512l2.652 4.637c.172.301.111.494-.043.77-.437.785-.882 1.564-1.335 2.34-.159.272-.352.375-.68.37-.777-.016-1.552-.01-2.327.016a.099.099 0 00-.081.05 575.097 575.097 0 01-2.705 4.74c-.169.293-.38.363-.725.364-.997.003-2.002.004-3.017.002a.537.537 0 01-.465-.271l-1.335-2.323a.09.09 0 00-.083-.049H4.982c-.285.03-.553-.001-.805-.092l-1.603-2.77a.543.543 0 01-.002-.54l1.207-2.12a.198.198 0 000-.197 550.951 550.951 0 01-1.875-3.272l-.79-1.395c-.16-.31-.173-.496.095-.965.465-.813.927-1.625 1.387-2.436.132-.234.304-.334.584-.335a338.3 338.3 0 012.589-.001.124.124 0 00.107-.063l2.806-4.895a.488.488 0 01.422-.246c.524-.001 1.053 0 1.583-.006L11.704 1c.341-.003.724.032.9.34zm-3.432.403a.06.06 0 00-.052.03L6.254 6.788a.157.157 0 01-.135.078H3.253c-.056 0-.07.025-.041.074l5.81 10.156c.025.042.013.062-.034.063l-2.795.015a.218.218 0 00-.2.116l-1.32 2.31c-.044.078-.021.118.068.118l5.716.008c.046 0 .08.02.104.061l1.403 2.454c.046.081.092.082.139 0l5.006-8.76.783-1.382a.055.055 0 01.096 0l1.424 2.53a.122.122 0 00.107.062l2.763-.02a.04.04 0 00.035-.02.041.041 0 000-.04l-2.9-5.086a.108.108 0 010-.113l.293-.507 1.12-1.977c.024-.041.012-.062-.035-.062H9.2c-.059 0-.073-.026-.043-.077l1.434-2.505a.107.107 0 000-.114L9.225 1.774a.06.06 0 00-.053-.031zm6.29 8.02c.046 0 .058.02.034.06l-.832 1.465-2.613 4.585a.056.056 0 01-.05.029.058.058 0 01-.05-.029L8.498 9.841c-.02-.034-.01-.052.028-.054l.216-.012 6.722-.012z">
                        </path>
                      </svg>
                      <h4 class="mb-0 font-14 ml-1">千问大模型</h4>
                    </div>

                  </template>
                  <a-doption value="qwen-plus">
                    <div class="flex justify-content-between min-w-48 items-center">
                      <div class="flex items-center">
                        <a-avatar :size="16" class="mr-1">
                          <img src="@/assets/images/qwen.png" alt="avatar" />
                        </a-avatar>
                        Qwen-Plus
                      </div>


                    </div>
                  </a-doption>
                  <a-doption value="qwen-turbo">
                    <div class="flex justify-content-between min-w-48 items-center">
                      <div class="flex items-center">
                        <a-avatar :size="16" class="mr-1">
                          <img src="@/assets/images/qwen.png" alt="avatar" />
                        </a-avatar>
                        Qwen-turbo
                      </div>


                    </div>
                  </a-doption>
                </a-dgroup>
                <a-dgroup v-if="counter.setting.tencent_chat_open == '1'">
                  <template #title>
                    <div class="flex items-center mb-2">
                      <svg t="1717144835440" class="icon" viewBox="0 0 1032 1024" version="1.1"
                        xmlns="http://www.w3.org/2000/svg" p-id="29320" width="16" height="16">
                        <path d="M3.796984 0h1018.143079v1018.143079h-1018.143079z" fill="#CCCCCC" fill-opacity="0"
                          p-id="29321"></path>
                        <path
                          d="M448.476277 1016.17573l-13.151015-498.465883c-26.514143-9.720085 80.597691-135.736502 124.563442-124.61647 128.917065-32.400282 269.060217-237.58793 13.204043-389.757898-774.159938 0-689.33059 951.857722-124.61647 1012.840251z"
                          fill="#B3DDF2" p-id="29322"></path>
                        <path
                          d="M446.021067 1015.942405c-230.673041-53.028285-456.425058-375.800853-180.29617-665.504981 63.421829-55.902418-63.262744-220.942351-167.039099-129.919299-275.725873 381.3264 86.908057 796.458332 347.335269 795.42428z"
                          fill="#0055E9" p-id="29323"></path>
                        <path
                          d="M408.827028 536.27505c0-2.651414-6.363394 4.576341 0 0z m0 0v39.771214c0 5.302829-7.42396 40.566638-10.605657 55.679699l39.771214 84.845257s26.514143 7.954243 29.165557 10.605657 15.643344 4.507404 21.211314 5.302829l55.6797 34.468385 92.799499-13.257071 119.313642-37.1198 111.359399-95.450914 34.468386-58.331113 29.165557-148.479199-5.302829-68.936771v-60.982529l-60.982528-111.359399-31.816971-39.771214-55.6797-50.376871-47.725457-29.165557-13.257071-7.954243-15.908486-5.302828-29.165557-10.605657-92.799499-23.862729c201.507484 66.285357 217.41597 270.444255 159.084856 368.546583s-184.713426 154.736537-307.564055 143.176371l-21.211314 18.5599z"
                          fill="#00BCFF" p-id="29324"></path>
                        <path
                          d="M461.828799 1016.207546c180.29617 47.698943 575.192508-124.425569 570.054068-493.163053 13.267677-164.414199-140.196181-491.471452-389.757898-503.768711 278.218202 56.660723 384.508097 567.720823 23.915757 694.670538-180.338593 45.074043-246.608041-92.799499-233.324456-190.901827-185.535365 9.375401-283.955862 407.209506 29.112529 493.163053z"
                          fill="#0055DF" p-id="29325"></path>
                      </svg>
                      <h4 class="mb-0 font-14 ml-1">混元大模型</h4>
                    </div>

                  </template>
                  <a-doption value="ChatPro">
                    <div class="flex justify-content-between min-w-48 items-center">
                      <div class="flex items-center">
                        <svg t="1717144835440" class="icon mr-1" viewBox="0 0 1032 1024" version="1.1"
                          xmlns="http://www.w3.org/2000/svg" p-id="29320" width="16" height="16">
                          <path d="M3.796984 0h1018.143079v1018.143079h-1018.143079z" fill="#CCCCCC" fill-opacity="0"
                            p-id="29321"></path>
                          <path
                            d="M448.476277 1016.17573l-13.151015-498.465883c-26.514143-9.720085 80.597691-135.736502 124.563442-124.61647 128.917065-32.400282 269.060217-237.58793 13.204043-389.757898-774.159938 0-689.33059 951.857722-124.61647 1012.840251z"
                            fill="#B3DDF2" p-id="29322"></path>
                          <path
                            d="M446.021067 1015.942405c-230.673041-53.028285-456.425058-375.800853-180.29617-665.504981 63.421829-55.902418-63.262744-220.942351-167.039099-129.919299-275.725873 381.3264 86.908057 796.458332 347.335269 795.42428z"
                            fill="#0055E9" p-id="29323"></path>
                          <path
                            d="M408.827028 536.27505c0-2.651414-6.363394 4.576341 0 0z m0 0v39.771214c0 5.302829-7.42396 40.566638-10.605657 55.679699l39.771214 84.845257s26.514143 7.954243 29.165557 10.605657 15.643344 4.507404 21.211314 5.302829l55.6797 34.468385 92.799499-13.257071 119.313642-37.1198 111.359399-95.450914 34.468386-58.331113 29.165557-148.479199-5.302829-68.936771v-60.982529l-60.982528-111.359399-31.816971-39.771214-55.6797-50.376871-47.725457-29.165557-13.257071-7.954243-15.908486-5.302828-29.165557-10.605657-92.799499-23.862729c201.507484 66.285357 217.41597 270.444255 159.084856 368.546583s-184.713426 154.736537-307.564055 143.176371l-21.211314 18.5599z"
                            fill="#00BCFF" p-id="29324"></path>
                          <path
                            d="M461.828799 1016.207546c180.29617 47.698943 575.192508-124.425569 570.054068-493.163053 13.267677-164.414199-140.196181-491.471452-389.757898-503.768711 278.218202 56.660723 384.508097 567.720823 23.915757 694.670538-180.338593 45.074043-246.608041-92.799499-233.324456-190.901827-185.535365 9.375401-283.955862 407.209506 29.112529 493.163053z"
                            fill="#0055DF" p-id="29325"></path>
                        </svg>
                        ChatPro
                      </div>



                    </div>
                  </a-doption>
                  <a-doption value="ChatStd">
                    <div class="flex justify-content-between min-w-48 items-center">
                      <div class="flex items-center">
                        <svg t="1717144835440" class="icon mr-1" viewBox="0 0 1032 1024" version="1.1"
                          xmlns="http://www.w3.org/2000/svg" p-id="29320" width="16" height="16">
                          <path d="M3.796984 0h1018.143079v1018.143079h-1018.143079z" fill="#CCCCCC" fill-opacity="0"
                            p-id="29321"></path>
                          <path
                            d="M448.476277 1016.17573l-13.151015-498.465883c-26.514143-9.720085 80.597691-135.736502 124.563442-124.61647 128.917065-32.400282 269.060217-237.58793 13.204043-389.757898-774.159938 0-689.33059 951.857722-124.61647 1012.840251z"
                            fill="#B3DDF2" p-id="29322"></path>
                          <path
                            d="M446.021067 1015.942405c-230.673041-53.028285-456.425058-375.800853-180.29617-665.504981 63.421829-55.902418-63.262744-220.942351-167.039099-129.919299-275.725873 381.3264 86.908057 796.458332 347.335269 795.42428z"
                            fill="#0055E9" p-id="29323"></path>
                          <path
                            d="M408.827028 536.27505c0-2.651414-6.363394 4.576341 0 0z m0 0v39.771214c0 5.302829-7.42396 40.566638-10.605657 55.679699l39.771214 84.845257s26.514143 7.954243 29.165557 10.605657 15.643344 4.507404 21.211314 5.302829l55.6797 34.468385 92.799499-13.257071 119.313642-37.1198 111.359399-95.450914 34.468386-58.331113 29.165557-148.479199-5.302829-68.936771v-60.982529l-60.982528-111.359399-31.816971-39.771214-55.6797-50.376871-47.725457-29.165557-13.257071-7.954243-15.908486-5.302828-29.165557-10.605657-92.799499-23.862729c201.507484 66.285357 217.41597 270.444255 159.084856 368.546583s-184.713426 154.736537-307.564055 143.176371l-21.211314 18.5599z"
                            fill="#00BCFF" p-id="29324"></path>
                          <path
                            d="M461.828799 1016.207546c180.29617 47.698943 575.192508-124.425569 570.054068-493.163053 13.267677-164.414199-140.196181-491.471452-389.757898-503.768711 278.218202 56.660723 384.508097 567.720823 23.915757 694.670538-180.338593 45.074043-246.608041-92.799499-233.324456-190.901827-185.535365 9.375401-283.955862 407.209506 29.112529 493.163053z"
                            fill="#0055DF" p-id="29325"></path>
                        </svg>
                        ChatStd
                      </div>



                    </div>
                  </a-doption>
                </a-dgroup>
                <hr style="margin-top: 5px;margin-bottom: 11px!important;color:#D8D8D8 !important;">
                <a-dgroup v-if="counter.setting.kimi_open == '1'">
                  <template #title>
                    <div class="flex items-center mb-2">
                      <svg fill="currentColor" fill-rule="evenodd" height="12" viewBox="0 0 24 24" width="12"
                        xmlns="http://www.w3.org/2000/svg" style="flex: 0 0 auto; line-height: 1;">
                        <title>MoonshotAI</title>
                        <path
                          d="M1.052 16.916l9.539 2.552a21.007 21.007 0 00.06 2.033l5.956 1.593a11.997 11.997 0 01-5.586.865l-.18-.016-.044-.004-.084-.009-.094-.01a11.605 11.605 0 01-.157-.02l-.107-.014-.11-.016a11.962 11.962 0 01-.32-.051l-.042-.008-.075-.013-.107-.02-.07-.015-.093-.019-.075-.016-.095-.02-.097-.023-.094-.022-.068-.017-.088-.022-.09-.024-.095-.025-.082-.023-.109-.03-.062-.02-.084-.025-.093-.028-.105-.034-.058-.019-.08-.026-.09-.031-.066-.024a6.293 6.293 0 01-.044-.015l-.068-.025-.101-.037-.057-.022-.08-.03-.087-.035-.088-.035-.079-.032-.095-.04-.063-.028-.063-.027a5.655 5.655 0 01-.041-.018l-.066-.03-.103-.047-.052-.024-.096-.046-.062-.03-.084-.04-.086-.044-.093-.047-.052-.027-.103-.055-.057-.03-.058-.032a6.49 6.49 0 01-.046-.026l-.094-.053-.06-.034-.051-.03-.072-.041-.082-.05-.093-.056-.052-.032-.084-.053-.061-.039-.079-.05-.07-.047-.053-.035a7.785 7.785 0 01-.054-.036l-.044-.03-.044-.03a6.066 6.066 0 01-.04-.028l-.057-.04-.076-.054-.069-.05-.074-.054-.056-.042-.076-.057-.076-.059-.086-.067-.045-.035-.064-.052-.074-.06-.089-.073-.046-.039-.046-.039a7.516 7.516 0 01-.043-.037l-.045-.04-.061-.053-.07-.062-.068-.06-.062-.058-.067-.062-.053-.05-.088-.084a13.28 13.28 0 01-.099-.097l-.029-.028-.041-.042-.069-.07-.05-.051-.05-.053a6.457 6.457 0 01-.168-.179l-.08-.088-.062-.07-.071-.08-.042-.049-.053-.062-.058-.068-.046-.056a7.175 7.175 0 01-.027-.033l-.045-.055-.066-.082-.041-.052-.05-.064-.02-.025a11.99 11.99 0 01-1.44-2.402zm-1.02-5.794l11.353 3.037a20.468 20.468 0 00-.469 2.011l10.817 2.894a12.076 12.076 0 01-1.845 2.005L.657 15.923l-.016-.046-.035-.104a11.965 11.965 0 01-.05-.153l-.007-.023a11.896 11.896 0 01-.207-.741l-.03-.126-.018-.08-.021-.097-.018-.081-.018-.09-.017-.084-.018-.094c-.026-.141-.05-.283-.071-.426l-.017-.118-.011-.083-.013-.102a12.01 12.01 0 01-.019-.161l-.005-.047a12.12 12.12 0 01-.034-2.145zm1.593-5.15l11.948 3.196c-.368.605-.705 1.231-1.01 1.875l11.295 3.022c-.142.82-.368 1.612-.668 2.365l-11.55-3.09L.124 10.26l.015-.1.008-.049.01-.067.015-.087.018-.098c.026-.148.056-.295.088-.442l.028-.124.02-.085.024-.097c.022-.09.045-.18.07-.268l.028-.102.023-.083.03-.1.025-.082.03-.096.026-.082.031-.095a11.896 11.896 0 011.01-2.232zm4.442-4.4L17.352 4.59a20.77 20.77 0 00-1.688 1.721l7.823 2.093c.267.852.442 1.744.513 2.665L2.106 5.213l.045-.065.027-.04.04-.055.046-.065.055-.076.054-.072.064-.086.05-.065.057-.073.055-.07.06-.074.055-.069.065-.077.054-.066.066-.077.053-.06.072-.082.053-.06.067-.074.054-.058.073-.078.058-.06.063-.067.168-.17.1-.098.059-.056.076-.071a12.084 12.084 0 012.272-1.677zM12.017 0h.097l.082.001.069.001.054.002.068.002.046.001.076.003.047.002.06.003.054.002.087.005.105.007.144.011.088.007.044.004.077.008.082.008.047.005.102.012.05.006.108.014.081.01.042.006.065.01.207.032.07.012.065.011.14.026.092.018.11.022.046.01.075.016.041.01L14.7.3l.042.01.065.015.049.012.071.017.096.024.112.03.113.03.113.032.05.015.07.02.078.024.073.023.05.016.05.016.076.025.099.033.102.036.048.017.064.023.093.034.11.041.116.045.1.04.047.02.06.024.041.018.063.026.04.018.057.025.11.048.1.046.074.035.075.036.06.028.092.046.091.045.102.052.053.028.049.026.046.024.06.033.041.022.052.029.088.05.106.06.087.051.057.034.053.032.096.059.088.055.098.062.036.024.064.041.084.056.04.027.062.042.062.043.023.017c.054.037.108.075.161.114l.083.06.065.048.056.043.086.065.082.064.04.03.05.041.086.069.079.065.085.071c.712.6 1.353 1.283 1.909 2.031L7.222.994l.062-.027.065-.028.081-.034.086-.035c.113-.045.227-.09.341-.131l.096-.035.093-.033.084-.03.096-.031c.087-.03.176-.058.264-.085l.091-.027.086-.025.102-.03.085-.023.1-.026L9.04.37l.09-.023.091-.022.095-.022.09-.02.098-.021.091-.02.095-.018.092-.018.1-.018.091-.016.098-.017.092-.014.097-.015.092-.013.102-.013.091-.012.105-.012.09-.01.105-.01c.093-.01.186-.018.28-.024l.106-.008.09-.005.11-.006.093-.004.1-.004.097-.002.099-.002.197-.002z">
                        </path>
                      </svg>
                      <h4 class="mb-0 font-14 ml-1">Kimi大模型</h4>
                    </div>

                  </template>
                  <a-doption value="moonshot-v1-8k">
                    <div class="flex justify-content-between min-w-48 items-center">
                      <div class="flex items-center">
                        <a-avatar :size="16" class="mr-1">
                          <img src="@/assets/images/kimi.png" alt="avatar" />
                        </a-avatar>
                        moonshot-v1-8k
                      </div>



                    </div>
                  </a-doption>

                </a-dgroup>

              </template>
            </a-dropdown>
            <a-textarea placeholder="请输入内容" class="w-full mr-2 bg-white shadow-sm"
              :auto-size="{ minRows: 3, maxRows: 5 }" v-model="message_input"
              @keydown.enter.native.prevent="submitFormInput()" />
            <div class="absolute bottom-3 right-3 z-10">
              <a-button :loading="send_loading" size="small" type="primary" @click="submitFormInput()">
                <template #icon>
                  <icon-send />
                </template>
                发送
              </a-button>
            </div>

          </div>
        </form>
      </div>

    </div>
    <Login :login_dialog="login_dialog" @handleCancel="handleCancel" />

  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import {
  IconSend,
  IconPlus
} from '@arco-design/web-vue/es/icon'
import { Message } from "@arco-design/web-vue";
import { useCounter } from "~/store/counter";
import markdownIt from "markdown-it";
import hljs from "highlight.js";
import markdownItMatch from "markdown-it-math";
import mermaid from "mermaid";

const token = useCookie('token')
const counter = useCounter()
const handleSelect = (key: any) => {
  // 判断key的值改变model_big_choose的值
  if (key == 'xf' || key == 'xf2' || key == 'xf3' || key == 'xf35') {
    model_big_choose.value = 'fly'
    model_is_select.value = key
  } else if (key == 'ErnieBot' || key == 'ErnieBotTurbo' || key == 'ErnieBot4') {
    model_big_choose.value = 'baidu'
    model_is_select.value = key
  } else if (key == 'chatglm_pro' || key == 'chatglm_std' || key == 'chatglm_lite') {
    model_big_choose.value = 'chatglm'
    model_is_select.value = key
  } else if (key == 'qwen-plus' || key == 'qwen-turbo') {
    model_big_choose.value = 'qwen'
    model_is_select.value = key
  } else if (key == 'ChatPro' || key == 'ChatStd') {
    model_big_choose.value = 'tencent'
    model_is_select.value = key
  } else if (key == 'moonshot-v1-8k' || key == 'moonshot-v1-32k' || key == 'moonshot-v1-128k') {
    model_big_choose.value = 'kimi'
    model_is_select.value = key
  } else {
    model_big_choose.value = 'gpt'
    model_is_select.value = model_list.value[key].model
  }
}



const message_input = ref('')
const submitFormInput = () => {
  if (!message_input.value) {
    Message.warning('请输入内容')
    return
  }

  if (!token.value) {
    Message.warning('请先登录')
    login_dialog_click()
    return
  }

  if (ms_active.value == 0) {
    Message.warning('请选择一个会话')
    return
  }

  if (model_big_choose.value == "gpt") {
    submitForm();
  } else if (model_big_choose.value == "fly") {
    submitFormFly();
  } else if (model_big_choose.value == "baidu") {
    submitFormBaidu();
  } else if (model_big_choose.value == "chatglm") {
    submitFormGLM();
  } else if (model_big_choose.value == "qwen") {
    submitFormQwen();
  } else if (model_big_choose.value == "tencent") {
    submitFormTencent();
  } else if (model_big_choose.value == "kimi") {
    submitFormKimi();
  }
}

const left_loding = ref(false)
const data_load = ref(false)
const messages = ref([])
const page = ref(1)
const limit = ref(10)
const m_last = ref(0)
const ms_count = ref(0)
const max_session = ref(0)

const all_message = () => {
  left_loding.value = true;
  data_load.value = true;
  get_message({
    page: page.value,
    limit: limit.value,
  })
    .then((res: any) => {
      messages.value = res._rawValue.data;
      m_last.value = res._rawValue.m_last;
      ms_count.value = res._rawValue.count;
      max_session.value = res._rawValue.max_session;
      left_loding.value = false;
      data_load.value = false;
    })
    .catch((err: any) => {
      data_load.value = false;
      left_loding.value = false;
      console.log(err);
    });
};

if (token.value) {
  all_message()
}

const login_dialog = ref(false);
const login_dialog_click = () => {
  login_dialog.value = true;
};
const handleCancel = () => {
  login_dialog.value = false;
};
const me_message = ref([]) as any;

const model_list = ref([]) as any;
const s_page = ref(1);
const s_limit = ref(4);
const change_status = ref(true);
const model_is_select = ref();
const model_big_choose = ref(
  counter.setting.normal_ai_select ? counter.setting.normal_ai_select : "gpt"
);
const scene_p_model = ref([]);
const now_model_title = ref();
const scene_all = () => {
  get_scene_f({
    page: s_page.value,
    limit: s_limit.value,
  })
    .then((res: any) => {
      model_list.value = res._rawValue.model;
      if (model_big_choose.value == "gpt") {
        model_is_select.value = res._rawValue.model[0].model;
        now_model_title.value = res._rawValue.model[0].title;
      } else if (model_big_choose.value == "fly") {
        model_is_select.value = "xf3";
        now_model_title.value = "XF-Cloud-3";
      } else if (model_big_choose.value == "baidu") {
        model_is_select.value = "ErnieBot4";
        now_model_title.value = "Ernie-Bot-4.0";
      } else if (model_big_choose.value == "chatglm") {
        model_is_select.value = "chatglm_pro";
        now_model_title.value = "ChatGLM-PRO";
      } else if (model_big_choose.value == "qwen") {
        model_is_select.value = "qwen-plus";
        now_model_title.value = "Qwen-Plus";
      } else if (model_big_choose.value == "tencent") {
        model_is_select.value = "ChatPro";
        now_model_title.value = "ChatPro";
      } else if (model_big_choose.value == "kimi") {
        model_is_select.value = "moonshot-v1-8k";
        now_model_title.value = "moonshot-v1-8k";
      }
    })
    .catch((err: any) => {
      console.log(err);
    });
};
scene_all();

const handleCurrentChange = (val: number) => {
  left_loding.value = true;
  get_message({
    page: val,
    limit: limit,
  })
    .then((res: any) => {
      page.value = val;
      messages.value = res._rawValue.data;
      ms_count.value = res._rawValue.count;
      left_loding.value = false;
    })
    .catch((err: any) => {
      left_loding.value = false;
      console.log(err);
    });

};

const add_new_chat = () => {
  add_chat()
    .then((res: any) => {
      all_message();
      check_message(res._rawValue.data);
    })
    .catch((err: any) => {
      Message.error(err.message);
    });
};

const down_message = () => {
  setTimeout(() => {
    let chat = document.getElementsByClassName("chat-message-small")[0];
    chat.style.transition = "1500ms"; // 过渡时间为0.5秒
    chat.scrollTo({ top: chat.scrollHeight, behavior: "smooth" });
  }, 100);
};

const ms_active = ref(0);
const loadins = ref(false);
const renderMarkdown = (markdown: any) => {
  const md = markdownIt({
    linkify: true,
    highlight: (str, lang) => {
      if (lang === "mermaid") {
        return `<pre class="mermaid">${markdownIt().utils.escapeHtml(
          str
        )}</pre>`;
      }

      if (lang && hljs.getLanguage(lang)) {
        try {
          return `<pre class="hljs"><span ref="preCopy" class="pre_copy">Copy</span><code>${hljs.highlight(str, {
            language: lang,
            ignoreIllegals: true,
          }).value
            }</code></pre>`;
        } catch (__) { }
      }

      return `<pre class="hljs"><span ref="preCopy" class="pre_copy">Copy</span><code>${markdownIt().utils.escapeHtml(
        str
      )}</code></pre>`;
    },
    breaks: true,
  }).use(markdownItMatch, {
    inlineOpen: "$",
    inlineClose: "$",
    blockOpen: "$$$",
    blockClose: "$$$",
    renderingOptions: {},
  });

  md.renderer.rules.link_open = function (tokens, idx, options, env, self) {
    const aIndex = tokens[idx].attrIndex("href");
    const url = tokens[idx].attrs[aIndex][1];
    // 检查链接是否以图像扩展名结尾
    if (/\.(png|jpg|jpeg|gif|svg)$/i.test(url)) {
      // 如果是图像链接，则跳过链接文本和链接关闭标签
      let nextIndex = idx + 1;
      while (
        nextIndex < tokens.length &&
        tokens[nextIndex].type !== "link_close"
      ) {
        if (tokens[nextIndex].type === "text") {
          // 跳过文本
          tokens[nextIndex].content = "";
        }
        nextIndex++;
      }
      // 返回图像标签
      return `<img src="${url}" alt=""/>`;
    }
    // 否则，使用默认渲染器
    return self.renderToken(tokens, idx, options);
  };

  md.renderer.rules.link_close = function (tokens, idx, options, env, self) {
    const openToken = tokens[idx - 2];
    const aIndex = openToken.attrIndex("href");
    const url = openToken.attrs[aIndex][1];
    // 如果是图像链接，则不渲染链接关闭标签
    if (/\.(png|jpg|jpeg|gif|svg)$/i.test(url)) {
      return "";
    }
    // 否则，使用默认渲染器
    return self.renderToken(tokens, idx, options);
  };

  const renderedMarkdown = md.render(markdown);


  return renderedMarkdown;
};
const check_message = (id: number) => {
  return new Promise((resolve, reject) => {
    ms_active.value = id;
    loadins.value = true;
    c_message({
      session_id: id,
    })
      .then((res: any) => {
        me_message.value = res._rawValue.data;
        loadins.value = false;
        down_message();
        resolve(null);
      })
      .catch((err: any) => {
        loadins.value = false;
        reject(err);
      });
  });
};

watch(model_is_select, (val) => {

  if (val == 'ErnieBot') {
    now_model_title.value = 'Ernie-Bot'
  } else if (val == 'ErnieBotTurbo') {
    now_model_title.value = 'Ernie-Bot-turbo'
  } else if (val == 'ErnieBot4') {
    now_model_title.value = 'Ernie-Bot-4.0'
  } else if (val == 'xf' || val == 'xf2' || val == 'xf3' || val == 'xf35') {
    now_model_title.value = val == 'xf' ? 'XF-Cloud' : val == 'xf2' ? 'XF-Cloud-2' : val == 'xf3' ? 'XF-Cloud-3' : 'XF-Cloud-3.5'
  } else if (val == 'chatglm_pro' || val == 'chatglm_std' || val == 'chatglm_lite') {
    now_model_title.value = val == 'chatglm_pro' ? 'ChatGLM-PRO' : val == 'chatglm_std' ? 'ChatGLM-STD' : 'ChatGLM-LITE'
  } else if (val == 'qwen-plus' || val == 'qwen-turbo') {
    now_model_title.value = val == 'qwen-plus' ? 'Qwen-Plus' : 'Qwen-turbo'
  } else if (val == 'ChatPro' || val == 'ChatStd') {
    now_model_title.value = val == 'ChatPro' ? 'ChatPro' : 'ChatStd'
  } else if (val == 'moonshot-v1-8k' || val == 'moonshot-v1-32k' || val == 'moonshot-v1-128k') {
    now_model_title.value = val

  } else {
    const model = Object.values(model_list.value) as any
    for (let i = 0; i < model.length; i++) {
      if (model[i].model == val) {
        now_model_title.value = model[i].title
      }
    }

  }
})

const send_loading = ref(false);
const {
  public: { baseUrl },
} = useRuntimeConfig();

const headers = {
  Authorization: `Bearer ${token.value}`,
  Accept: "text/event-stream",
};

const up_stop = ref("start");
const is_done = ref(false);


const isInvalidJSON = (data: string) => {
  try {
    JSON.parse(data);
    return true; // 解析成功，是错误的 JSON 数据
  } catch (error) {
    return false; // 解析失败，不是错误的 JSON 数据
  }
};

const streams = ref();


const submitForm = async () => {
  if (message_input.value == "") {
    Message.warning("请输入内容");
    return false;
  }
  if (send_loading.value == true) {
    Message.warning("请等待上一条消息发送完成");
    return false;
  }
  if (event.shiftKey) {
    const textarea = event.target;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;

    // 在光标位置插入换行符
    message_input.value =
      message_input.value.substring(0, start) +
      '\n' +
      message_input.value.substring(end);

    // 更新光标位置
    await nextTick();
    textarea.selectionStart = textarea.selectionEnd = start + 1;

    // 阻止默认行为
    event.preventDefault();
    return false;
  }
  if (!token.value) {
    Message.warning("请先登录");
    login_dialog_click();
    return false;
  }

  send_loading.value = true;

  me_message.value.push({
    session_id: ms_active.value,
    question: message_input.value,
    message: "思考中...",
  });
  down_message();

  const res = await fetch(`${window.APP_CONFIG.baseUrl}send_bot`, {
    method: "POST",
    headers: headers,
    body: JSON.stringify({
      info: message_input.value,
      session_id: ms_active.value,
      scene_preset: [],
      model_is_select: model_is_select.value,
      answer_num: "",
      answer_tem: "",
      now_choose_knowledge: "",
      plugins_select: "",
      text_imageUrl: "",
    }),
  });

  up_stop.value = "start";
  if (res) {
    me_message.value[me_message.value.length - 1].message = "";
  }
  if (
    res.status == 500 ||
    res.status == 401 ||
    res.status == 405 ||
    res.status == 402 ||
    res.status == 403
  ) {
    const responseData = await res.json();
    send_loading.value = false;
    Message.error(responseData.message);
    return false;
  }

  let reply_in = false;

  let partialData = "";

  const stream = res.body?.getReader();
  const onData = ({ value }: { value: Uint8Array }) => {
    const chunk = new TextDecoder().decode(value);
    if (isInvalidJSON(chunk)) {
      const json = JSON.parse(chunk);
      if (json.error && json.error.message) {
        me_message.value[me_message.value.length - 1].message =
          json.error.message;
        return; // 或者进行其他错误处理
      }
      return;
    }
    const lines = (partialData + chunk).split("\n");

    partialData = lines.pop() || "";

    for (const line of lines) {
      if (line.trim() === "data: [DONE]") {
        // 如果是最后一行，跳过处理
        continue;
      }

      try {
        const trimmedLine = line.trim(); // 去除行首尾的空格
        if (trimmedLine.startsWith("data:")) {
          const jsonData = trimmedLine.slice(5); // 去除 "data:" 前缀
          const json = JSON.parse(jsonData);
          if (json.choices) {
            for (const choice of json.choices) {
              const content = choice.delta?.content;
              if (content) {
                me_message.value[me_message.value.length - 1].message +=
                  content;
                setTimeout(() => {
                  down_message();
                }, 2000);
              }
              if (choice.finish_reason === "stop") {
                break;
              }
            }
          }
        }
      } catch (e) {
        console.error(e);
      }
    }
  };

  const read = async () => {
    const result = await stream?.read();
    if (up_stop.value == "end") {
      console.log("end");
      up_stop.value = "start";
      stream?.cancel();
      return false;
    }
    if (result?.done) {
      console.log("done");
      is_done.value = true;
      send_loading.value = false;
      message_input.value = "";
      await check_message(ms_active.value);
    } else {
      send_loading.value = true;
      is_done.value = false;
      onData(result!);
      await read();
    }
  };
  await read();
};

const submitFormFly = async () => {
  if (message_input.value == "") {
    Message.warning("请输入内容");
    return false;
  }
  if (send_loading.value == true) {
    Message.warning("请等待上一条消息发送完成");
    return false;
  }
  if (event.shiftKey) {
    // 按下shift键，插入换行符
    const textarea = event.target;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;

    // 在光标位置插入换行符
    message_input.value =
      message_input.value.substring(0, start) +
      '\n' +
      message_input.value.substring(end);

    // 更新光标位置
    await nextTick();
    textarea.selectionStart = textarea.selectionEnd = start + 1;

    // 阻止默认行为
    event.preventDefault();
    return false;
  }
  if (!token.value) {
    Message.warning("请先登录");
    login_dialog_click();
    return false;
  }

  send_loading.value = true;
  me_message.value.push({
    session_id: ms_active.value,
    question: message_input.value,
    message: "思考中...",
  });
  down_message();
  const formData = new FormData();
  formData.append("info", message_input.value);
  formData.append("session_id", ms_active.value as any);
  formData.append("scene_preset", [] as any);
  formData.append("model_is_select", model_is_select.value);
  formData.append("answer_num", "" as any);
  formData.append("answer_tem", "" as any);
  formData.append("now_choose_knowledge", "" as any);
  const res = await fetch(`${window.APP_CONFIG.baseUrl}send_fly_msg`, {
    method: "POST",
    headers: headers,
    body: formData,
  });
  up_stop.value = "start";
  if (res) {
    me_message.value[me_message.value.length - 1].message = "";
  }
  if (res.status == 500) {
    send_loading.value = false;
    Message.error("服务器错误");
    return false;
  }

  if (res.status == 401) {
    send_loading.value = false;
    Message.error("请先登录");
    return false;
  }
  if (res.status == 402) {
    send_loading.value = false;
    me_message.value[me_message.value.length - 1].message =
      "发送次数已达上限或余额不足";
    Message.error("发送次数已达上限或余额不足");
    return false;
  }
  if (res.status == 403) {
    send_loading.value = false;
    me_message.value[me_message.value.length - 1].message = "禁止发送违禁词";
    Message.error("禁止发送违禁词");
    return false;
  }
  let reply_in = false;
  const stream = res.body?.getReader();
  const onData = ({ value }: { value: Uint8Array }) => {
    let result = new TextDecoder().decode(value);
    let arr = result.split("\n\n").map((str) => str.replace(/\n/g, ""));
    let new_arr: any[] = [];

    for (let i = 0; i < arr.length; i++) {
      is_done.value = false;
      if (arr[i].slice(-2) == "}}" && arr[i].startsWith("data:")) {
        new_arr.push(JSON.parse(arr[i].replace("data:", "")));
      } else if (arr[i].startsWith("data:") && arr[i].slice(-2) != "]}") {
        streams.value = arr[i].replace("data:", "");
      } else if (
        arr[i].slice(-2) == "}}" &&
        arr[i].startsWith("data:") == false
      ) {
        // 与streams.value拼接成一个字符串
        let str = (streams.value += arr[i]);
        new_arr.push(JSON.parse(str.replace("data:", "")));
        streams.value = "";
      } else {
        if (arr[i].includes('"error"')) {
          me_message.value[me_message.value.length - 1].message = JSON.parse(
            arr[i]
          ).error.message;
        }
        streams.value = "";
      }

      if (arr[i].includes("reply_content:")) {
        reply_in = true;
      }
      if (reply_in) {
        let replyContent = arr[i];
        let content = replyContent.substring(14);
        for (let i = 0; i < content.length; i++) {
          setTimeout(() => {
            me_message.value[me_message.value.length - 1].message +=
              content.charAt(i);
            setTimeout(() => {
              down_message();
            }, 2000);
          }, 1000);
        }
      }
    }
    for (let i = 0; i < new_arr.length; i++) {
      setTimeout(() => {
        if (new_arr[i].payload.choices.text[0].content) {
          me_message.value[me_message.value.length - 1].message +=
            new_arr[i].payload.choices.text[0].content;
        }
        setTimeout(() => {
          down_message();
        }, 2000);
      }, 100);
    }
  };

  const read = async () => {
    const result = await stream?.read();
    if (up_stop.value == "end") {
      console.log("end");
      up_stop.value = "start";
      stream?.cancel();
      return false;
    }
    if (result?.done) {
      console.log("done");
      is_done.value = true;

      send_loading.value = false;
      message_input.value = "";
      await check_message(ms_active.value);
    } else {
      send_loading.value = true;
      is_done.value = false;
      onData(result!);
      await read();
    }
  };
  await read();
};
const submitFormBaidu = async () => {
  if (message_input.value == "") {
    Message.warning("请输入内容");
    return false;
  }
  if (send_loading.value == true) {
    Message.warning("请等待上一条消息发送完成");
    return false;
  }
  if (event.shiftKey) {
    // 按下shift键，插入换行符
    const textarea = event.target;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;

    // 在光标位置插入换行符
    message_input.value =
      message_input.value.substring(0, start) +
      '\n' +
      message_input.value.substring(end);

    // 更新光标位置
    await nextTick();
    textarea.selectionStart = textarea.selectionEnd = start + 1;

    // 阻止默认行为
    event.preventDefault();
    return false;
  }
  if (!token.value) {
    Message.warning("请先登录");
    login_dialog_click();
    return false;
  }

  send_loading.value = true;
  me_message.value.push({
    session_id: ms_active.value,
    question: message_input.value,
    message: "思考中...",
  });
  down_message();
  const formData = new FormData();
  formData.append("info", message_input.value);
  formData.append("session_id", ms_active.value as any);
  formData.append("scene_preset", [] as any);
  formData.append("model_is_select", model_is_select.value);
  formData.append("answer_num", "" as any);
  formData.append("answer_tem", "" as any);
  formData.append("now_choose_knowledge", "" as any);
  const res = await fetch(`${window.APP_CONFIG.baseUrl}run_baidu_send`, {
    method: "POST",
    headers: headers,
    body: formData,
  });
  up_stop.value = "start";
  if (res) {
    me_message.value[me_message.value.length - 1].message = "";
  }
  if (res.status == 500) {
    send_loading.value = false;
    Message.error("服务器错误");
    return false;
  }
  if (res.status == 401) {
    send_loading.value = false;
    Message.error("请先登录");
    return false;
  }
  if (res.status == 402) {
    send_loading.value = false;
    me_message.value[me_message.value.length - 1].message =
      "发送次数已达上限或余额不足";
    Message.error("发送次数已达上限或余额不足");
    return false;
  }
  if (res.status == 403) {
    send_loading.value = false;
    me_message.value[me_message.value.length - 1].message = "禁止发送违禁词";
    Message.error("禁止发送违禁词");
    return false;
  }
  let reply_in = false;
  let partialData = "";
  const stream = res.body?.getReader();

  const onData = ({ value }: { value: Uint8Array }) => {
    let result = new TextDecoder().decode(value);
    let arr = result.split("\n\n").map((str) => str.replace(/\n/g, ""));
    let new_arr: any[] = [];

    for (let i = 0; i < arr.length; i++) {
      is_done.value = false;
      if (arr[i].slice(-2) == "}}" && arr[i].startsWith("data:")) {
        new_arr.push(JSON.parse(arr[i].replace("data:", "")));
      } else if (arr[i].startsWith("data:") && arr[i].slice(-2) != "]}") {
        streams.value = arr[i].replace("data:", "");
      } else if (
        arr[i].slice(-2) == "}}" &&
        arr[i].startsWith("data:") == false
      ) {
        // 与streams.value拼接成一个字符串
        let str = (streams.value += arr[i]);
        new_arr.push(JSON.parse(str.replace("data:", "")));
        streams.value = "";
      } else {
        if (arr[i].includes('"error_msg"')) {
          me_message.value[me_message.value.length - 1].message = JSON.parse(
            arr[i]
          ).error_msg;
        }
        streams.value = "";
      }

      if (arr[i].includes("reply_content:")) {
        reply_in = true;
      }
      if (reply_in) {
        let replyContent = arr[i];
        let content = replyContent.substring(14);
        for (let i = 0; i < content.length; i++) {
          setTimeout(() => {
            me_message.value[me_message.value.length - 1].message +=
              content.charAt(i);
            setTimeout(() => {
              down_message();
            }, 2000);
          }, 1000);
        }
      }
    }
    for (let i = 0; i < new_arr.length; i++) {
      setTimeout(() => {
        if (new_arr[i].result) {
          me_message.value[me_message.value.length - 1].message +=
            new_arr[i].result;
        }
        setTimeout(() => {
          down_message();
        }, 2000);
      }, 100);
    }
  };

  const read = async () => {
    const result = await stream?.read();
    if (up_stop.value == "end") {
      console.log("end");
      up_stop.value = "start";
      stream?.cancel();
      return false;
    }
    if (result?.done) {
      console.log("done");
      is_done.value = true;

      send_loading.value = false;
      message_input.value = "";
      await check_message(ms_active.value);
    } else {
      send_loading.value = true;
      is_done.value = false;
      onData(result!);
      await read();
    }
  };
  await read();
};

const submitFormGLM = async () => {
  if (message_input.value == "") {
    Message.warning("请输入内容");
    return false;
  }
  if (send_loading.value == true) {
    Message.warning("请等待上一条消息发送完成");
    return false;
  }
  if (event.shiftKey) {
    // 按下shift键，插入换行符
    const textarea = event.target;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;

    // 在光标位置插入换行符
    message_input.value =
      message_input.value.substring(0, start) +
      '\n' +
      message_input.value.substring(end);

    // 更新光标位置
    await nextTick();
    textarea.selectionStart = textarea.selectionEnd = start + 1;

    // 阻止默认行为
    event.preventDefault();
    return false;
  }
  if (!token.value) {
    Message.warning("请先登录");
    login_dialog_click();
    return false;
  }

  send_loading.value = true;
  me_message.value.push({
    session_id: ms_active.value,
    question: message_input.value,
    message: "思考中...",
  });
  down_message();
  const formData = new FormData();
  formData.append("info", message_input.value);
  formData.append("session_id", ms_active.value as any);
  formData.append("scene_preset", [] as any);
  formData.append("model_is_select", model_is_select.value);
  formData.append("answer_num", "" as any);
  formData.append("answer_tem", "" as any);
  formData.append("now_choose_knowledge", "" as any);
  const res = await fetch(`${window.APP_CONFIG.baseUrl}run_chatglm_send`, {
    method: "POST",
    headers: headers,
    body: formData,
  });
  up_stop.value = "start";
  if (res) {
    me_message.value[me_message.value.length - 1].message = "";
  }
  if (res.status == 500) {
    send_loading.value = false;
    Message.error("服务器错误");
    return false;
  }
  if (res.status == 401) {
    send_loading.value = false;
    Message.error("请先登录");
    return false;
  }
  if (res.status == 402) {
    send_loading.value = false;
    me_message.value[me_message.value.length - 1].message =
      "发送次数已达上限或余额不足";
    Message.error("发送次数已达上限或余额不足");
    return false;
  }
  if (res.status == 403) {
    send_loading.value = false;
    me_message.value[me_message.value.length - 1].message = "禁止发送违禁词";
    Message.error("禁止发送违禁词");
    return false;
  }
  let reply_in = false;
  const stream = res.body?.getReader();
  const onData = ({ value }: { value: Uint8Array }) => {
    let result = new TextDecoder().decode(value);
    let lines = result.split("\n"); // Split the string into lines
    let currentEvent = "";
    let currentID = "";
    let currentData = "";
    let events = [] as any; // 存储事件
    lines.forEach((line) => {
      if (line.startsWith("event:")) {
        // 如果当前有事件未完成，需要先将其添加到events中，然后再开始新的事件
        if (currentEvent && currentID && currentData) {
          events.push({
            event: currentEvent,
            id: currentID,
            data: currentData,
          });
        }
        currentEvent = line.split(":")[1]?.trim() || "";
        currentID = "";
        currentData = "";
      } else if (line.startsWith("id:")) {
        currentID = line.split(":")[1]?.trim() || "";
      } else if (line.startsWith("data:")) {
        // 每次遇到新的"data:"都添加到currentData中
        if (currentData) {
          currentData += "\n" + line.slice("data:".length);
        } else {
          currentData = line.slice("data:".length);
        }
      }

      // 如果事件、ID 和数据都存在，则存入 events
      if (currentEvent && currentID && currentData) {
        events.push({
          event: currentEvent,
          id: currentID,
          data: currentData,
        });
        // 重置当前的事件、ID 和数据
        currentEvent = "";
        currentID = "";
        currentData = "";
      }
    });
    for (let i = 0; i < events.length; i++) {
      me_message.value[me_message.value.length - 1].message += events[i].data;
      setTimeout(() => {
        down_message();
      }, 2000);
    }
  };

  const read = async () => {
    const result = await stream?.read();
    if (up_stop.value == "end") {
      console.log("end");
      up_stop.value = "start";
      stream?.cancel();
      return false;
    }
    if (result?.done) {
      console.log("done");
      is_done.value = true;

      send_loading.value = false;
      message_input.value = "";
      await check_message(ms_active.value);
    } else {
      send_loading.value = true;
      is_done.value = false;
      onData(result!);
      await read();
    }
  };
  await read();
};

const submitFormQwen = async () => {
  if (message_input.value == "") {
    Message.warning("请输入内容");
    return false;
  }
  if (send_loading.value == true) {
    Message.warning("请等待上一条消息发送完成");
    return false;
  }
  if (event.shiftKey) {
    // 按下shift键，插入换行符
    const textarea = event.target;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;

    // 在光标位置插入换行符
    message_input.value =
      message_input.value.substring(0, start) +
      '\n' +
      message_input.value.substring(end);

    // 更新光标位置
    await nextTick();
    textarea.selectionStart = textarea.selectionEnd = start + 1;

    // 阻止默认行为
    event.preventDefault();
    return false;
  }
  if (!token.value) {
    Message.warning("请先登录");
    login_dialog_click();
    return false;
  }

  send_loading.value = true;
  me_message.value.push({
    session_id: ms_active.value,
    question: message_input.value,
    message: "思考中...",
  });
  down_message();
  const formData = new FormData();
  formData.append("info", message_input.value);
  formData.append("session_id", ms_active.value as any);
  formData.append("scene_preset", [] as any);
  formData.append("model_is_select", model_is_select.value);
  formData.append("answer_num", "" as any);
  formData.append("answer_tem", "" as any);
  formData.append("now_choose_knowledge", "" as any);
  const res = await fetch(`${window.APP_CONFIG.baseUrl}run_ali_send`, {
    method: "POST",
    headers: headers,
    body: formData,
  });
  up_stop.value = "start";
  if (res) {
    me_message.value[me_message.value.length - 1].message = "";
  }
  if (res.status == 500) {
    send_loading.value = false;
    Message.error("服务器错误");
    return false;
  }
  if (res.status == 401) {
    send_loading.value = false;
    Message.error("请先登录");
    return false;
  }
  if (res.status == 402) {
    send_loading.value = false;
    me_message.value[me_message.value.length - 1].message =
      "发送次数已达上限或余额不足";
    Message.error("发送次数已达上限或余额不足");
    return false;
  }
  if (res.status == 403) {
    send_loading.value = false;
    me_message.value[me_message.value.length - 1].message = "禁止发送违禁词";
    Message.error("禁止发送违禁词");
    return false;
  }
  let reply_in = false;
  const stream = res.body?.getReader();
  const onData = ({ value }: { value: Uint8Array }) => {
    let result = new TextDecoder().decode(value);
    let lines = result.split("\n"); // Split the string into lines
    let currentEvent = "";
    let currentID = "";
    let currentData = "";
    let events = [] as any; // 存储事件
    let combinedText = ""; // 存储所有事件的 text 字段

    lines.forEach((line) => {
      if (line.startsWith("event:")) {
        currentEvent = line.split(":")[1]?.trim() || "";
      } else if (line.startsWith("id:")) {
        currentID = line.split(":")[1]?.trim() || "";
      } else if (line.startsWith("data:")) {
        if (currentData) {
          currentData += "\n" + line.slice("data:".length);
        } else {
          currentData = line.slice("data:".length);
        }

        if (currentEvent && currentData) {
          let text = "";
          try {
            let parsedData = JSON.parse(currentData);
            if (parsedData.output && parsedData.output.text) {
              text = parsedData.output.text;
            }
          } catch (error) {
            console.error("解析 data 字段时出错:", error);
          }
          events.push({
            event: currentEvent,
            id: currentID,
            data: currentData,
            text: text,
          });

          combinedText += text; // 将当前事件的 text 字段添加到 combinedText 中

          // 重置当前的事件、ID 和数据
          currentEvent = "";
          currentID = "";
          currentData = "";
        }
      }
    });

    // 在这里，你可以根据需要处理 events 数组
    for (let i = 0; i < events.length; i++) {
      me_message.value[me_message.value.length - 1].message += combinedText;
      setTimeout(() => {
        down_message();
      }, 2000);
    }
  };

  const read = async () => {
    const result = await stream?.read();
    if (up_stop.value == "end") {
      console.log("end");
      up_stop.value = "start";
      stream?.cancel();
      return false;
    }
    if (result?.done) {
      console.log("done");
      is_done.value = true;

      send_loading.value = false;
      message_input.value = "";
      await check_message(ms_active.value);
    } else {
      send_loading.value = true;
      is_done.value = false;
      onData(result!);
      await read();
    }
  };
  await read();
};

const submitFormTencent = async () => {
  if (message_input.value == "") {
    Message.warning("请输入内容");
    return false;
  }
  if (send_loading.value == true) {
    Message.warning("请等待上一条消息发送完成");
    return false;
  }
  if (event.shiftKey) {
    // 按下shift键，插入换行符
    const textarea = event.target;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;

    // 在光标位置插入换行符
    message_input.value =
      message_input.value.substring(0, start) +
      '\n' +
      message_input.value.substring(end);

    // 更新光标位置
    await nextTick();
    textarea.selectionStart = textarea.selectionEnd = start + 1;

    // 阻止默认行为
    event.preventDefault();
    return false;
  }
  if (!token.value) {
    Message.warning("请先登录");
    login_dialog_click();
    return false;
  }

  send_loading.value = true;
  me_message.value.push({
    session_id: ms_active.value,
    question: message_input.value,
    message: "思考中...",
  });
  down_message();
  const formData = new FormData();
  formData.append("info", message_input.value);
  formData.append("session_id", ms_active.value as any);
  formData.append("scene_preset", [] as any);
  formData.append("model_is_select", model_is_select.value);
  formData.append("answer_num", "" as any);
  formData.append("answer_tem", "" as any);
  formData.append("now_choose_knowledge", "" as any);
  const res = await fetch(`${window.APP_CONFIG.baseUrl}run_hunyuan_send`, {
    method: "POST",
    headers: headers,
    body: formData,
  });
  up_stop.value = "start";
  if (res) {
    me_message.value[me_message.value.length - 1].message = "";
  }
  if (res.status == 500) {
    send_loading.value = false;
    Message.error("服务器错误");
    return false;
  }
  if (res.status == 401) {
    send_loading.value = false;
    Message.error("请先登录");
    return false;
  }
  if (res.status == 402) {
    send_loading.value = false;
    me_message.value[me_message.value.length - 1].message =
      "发送次数已达上限或余额不足";
    Message.error("发送次数已达上限或余额不足");
    return false;
  }
  if (res.status == 403) {
    send_loading.value = false;
    me_message.value[me_message.value.length - 1].message = "禁止发送违禁词";
    Message.error("禁止发送违禁词");
    return false;
  }
  let reply_in = false;
  const stream = res.body?.getReader();
  let partialData = "";

  const onData = ({ value }: { value: Uint8Array }) => {
    const chunk = new TextDecoder().decode(value);
    if (isInvalidJSON(chunk)) {
      const json = JSON.parse(chunk);
      if (json.error && json.error.message) {
        me_message.value[me_message.value.length - 1].message =
          json.error.message;
        return; // 或者进行其他错误处理
      }
      return;
    }
    const lines = (partialData + chunk).split("\n");

    partialData = lines.pop() || "";

    for (const line of lines) {
      try {
        const trimmedLine = line.trim(); // 去除行首尾的空格
        if (trimmedLine.startsWith("data:")) {
          const jsonData = trimmedLine.slice(5); // 去除 "data:" 前缀
          const json = JSON.parse(jsonData);
          if (json.Choices) {
            for (const choice of json.Choices) {
              const content = choice.Delta?.Content;
              if (content) {
                me_message.value[me_message.value.length - 1].message +=
                  content;
                setTimeout(() => {
                  down_message();
                }, 2000);
              }
              if (choice.finish_reason === "stop") {
                break;
              }
            }
          }
        }
      } catch (e) {
        console.error(e);
      }
    }
  };

  const read = async () => {
    const result = await stream?.read();
    if (up_stop.value == "end") {
      console.log("end");
      up_stop.value = "start";
      stream?.cancel();
      return false;
    }
    if (result?.done) {
      console.log("done");
      is_done.value = true;

      send_loading.value = false;
      message_input.value = "";
      await check_message(ms_active.value);
    } else {
      send_loading.value = true;
      is_done.value = false;
      onData(result!);
      await read();
    }
  };
  await read();
};

const submitFormKimi = async () => {
  if (message_input.value == "") {
    Message.warning("请输入内容");
    return false;
  }
  if (send_loading.value == true) {
    Message.warning("请等待上一条消息发送完成");
    return false;
  }
  if (event.shiftKey) {
    // 按下shift键，插入换行符
    const textarea = event.target;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;

    // 在光标位置插入换行符
    message_input.value =
      message_input.value.substring(0, start) +
      '\n' +
      message_input.value.substring(end);

    // 更新光标位置
    await nextTick();
    textarea.selectionStart = textarea.selectionEnd = start + 1;

    // 阻止默认行为
    event.preventDefault();
    return false;
  }
  if (!token.value) {
    Message.warning("请先登录");
    login_dialog_click();
    return false;
  }

  send_loading.value = true;

  me_message.value.push({
    session_id: ms_active.value,
    question: message_input.value,
    message: "思考中...",
  });
  down_message();

  const formData = new FormData();
  formData.append("info", message_input.value);
  formData.append("session_id", ms_active.value as any);
  formData.append("scene_preset", [] as any);
  formData.append("model_is_select", model_is_select.value);
  formData.append("answer_num", "" as any);
  formData.append("answer_tem", "" as any);
  formData.append("now_choose_knowledge", "" as any);
  const res = await fetch(`${window.APP_CONFIG.baseUrl}send_kimi`, {
    method: "POST",
    headers: headers,
    body: formData,
  });

  up_stop.value = "start";
  if (res) {
    me_message.value[me_message.value.length - 1].message = "";
  }
  if (
    res.status == 500 ||
    res.status == 401 ||
    res.status == 405 ||
    res.status == 402 ||
    res.status == 403
  ) {
    const responseData = await res.json();
    send_loading.value = false;
    Message.error(responseData.message);
    return false;
  }

  let reply_in = false;

  let partialData = "";

  const stream = res.body?.getReader();
  const onData = ({ value }: { value: Uint8Array }) => {
    const chunk = new TextDecoder().decode(value);
    if (isInvalidJSON(chunk)) {
      const json = JSON.parse(chunk);
      if (json.error && json.error.message) {
        me_message.value[me_message.value.length - 1].message =
          json.error.message;
        return; // 或者进行其他错误处理
      }
      return;
    }
    const lines = (partialData + chunk).split("\n");

    partialData = lines.pop() || "";

    for (const line of lines) {
      if (line.trim() === "data: [DONE]") {
        // 如果是最后一行，跳过处理
        continue;
      }

      try {
        const trimmedLine = line.trim(); // 去除行首尾的空格
        if (trimmedLine.startsWith("data:")) {
          const jsonData = trimmedLine.slice(5); // 去除 "data:" 前缀
          const json = JSON.parse(jsonData);
          if (json.choices) {
            for (const choice of json.choices) {
              const content = choice.delta?.content;
              if (content) {
                me_message.value[me_message.value.length - 1].message +=
                  content;
                setTimeout(() => {
                  down_message();
                }, 2000);
              }
              if (choice.finish_reason === "stop") {
                break;
              }
            }
          }
        }
      } catch (e) {
        console.error(e);
      }
    }
  };

  const read = async () => {
    const result = await stream?.read();
    if (up_stop.value == "end") {
      console.log("end");
      up_stop.value = "start";
      stream?.cancel();
      return false;
    }
    if (result?.done) {
      console.log("done");
      is_done.value = true;

      send_loading.value = false;
      message_input.value = "";
      await check_message(ms_active.value);
    } else {
      send_loading.value = true;
      is_done.value = false;
      onData(result!);
      await read();
    }
  };
  await read();
};


</script>

<style scoped></style>
